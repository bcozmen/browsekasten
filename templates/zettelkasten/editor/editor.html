{% load static %}

<div class="editor">
    <div class="sub-editor">
        <div class="tab-bar">
            <!-- Tab bar content goes here -->
        </div>
        <form method="post" class="markdown-editor" id="sub-editor">
            {% csrf_token %}
            <textarea id="code-editor" name="content">{{ content|default:'' }}</textarea>
        </form>
    </div>
</div>



<!-- CodeMirror Core CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">

<!-- Custom CodeMirror Theme -->
<link rel="stylesheet" href="{% static 'css/05-ide/_codemirror.css' %}">

<!-- Shared Markdown Styling (works for both editor and blog) -->
<link rel="stylesheet" href="{% static 'css/05-ide/_markdown-preview.css' %}">

<!-- CodeMirror Addon CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/dialog/dialog.min.css">

<!--
    JAVASCRIPT INCLUDES
    
    Load all necessary JavaScript libraries and components.
    Order matters for dependencies.
-->

<!-- CodeMirror Core -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>

<!-- CodeMirror Language Modes -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>

<!-- CodeMirror Addons -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/selection/active-line.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/markdown-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/searchcursor.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/search.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/dialog/dialog.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/anyword-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/keymap/sublime.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/replace.min.js"></script>

<!-- Markdown Parser -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- Custom Components -->
<script src="{% static 'js/03-components/ide/markdown-live-preview.js' %}"></script>
<script src="{% static 'js/03-components/ide/markdown-formatter.js' %}"></script>
<script src="{% static 'js/03-components/ide/editor-search.js' %}"></script>

<!--
    EDITOR INITIALIZATION SCRIPT
    
    This script ties together all the components and initializes the complete editor system.
    It's kept minimal by delegating functionality to the modular components.
-->
<script>
    /**
     * EDITOR INITIALIZATION
     * 
     * Initialize the complete markdown editor system when the DOM is ready.
     * This script coordinates all the modular components into a cohesive editor.
     */
    document.addEventListener("DOMContentLoaded", function () {
        
        /**
         * CODEMIRROR EDITOR INITIALIZATION
         * 
         * Create the main CodeMirror editor instance with optimal configuration
         * for markdown editing with live preview.
         */
        const editor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
            // BASIC CONFIGURATION
            mode: "markdown",           // Enable markdown syntax highlighting
            theme: "mytheme",          // Use custom CSS theme (defined in _codemirror.css)
            lineNumbers: true,         // Show line numbers in gutter
            lineWrapping: true,        // Wrap long lines instead of horizontal scroll
            styleActiveLine: true,     // Highlight the current line
            
            // BRACKET MATCHING AND AUTO-COMPLETION
            matchBrackets: true,       // Highlight matching brackets
            autoCloseBrackets: true,   // Automatically close brackets/quotes
            
            // CODE FOLDING SUPPORT
            foldGutter: true,          // Enable code folding in gutter
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
            
            // INPUT AND ACCESSIBILITY
            inputStyle: "contenteditable",  // Better mobile support and accessibility
            spellcheck: true,              // Enable browser spellcheck
            
            // KEYBOARD SHORTCUTS AND BEHAVIOR
            keyMap: "sublime",         // Use Sublime Text-style keyboard shortcuts
            
            /**
             * CUSTOM KEYBOARD SHORTCUTS
             * 
             * Define additional keyboard shortcuts that integrate with our components.
             */
            extraKeys: {
                // COMPLETION AND FOLDING
                "Ctrl-Space": "autocomplete",                    // Trigger word completion
                "Ctrl-Q": function(cm) { cm.foldCode(cm.getCursor()); }, // Toggle code folding
                
                // SEARCH AND REPLACE (integrated with our search component)
                "Ctrl-F": function(cm) { 
                    // Focus the find input that's already visible
                    document.getElementById('find-input').focus();
                },
                "Ctrl-H": function(cm) { 
                    // Focus the replace input that's already visible
                    document.getElementById('replace-input').focus();
                },
                "Esc": function(cm) {
                    // Clear search inputs
                    document.getElementById('find-input').value = '';
                    document.getElementById('replace-input').value = '';
                    if (window.searcher) {
                        window.searcher.clearSearch();
                    }
                },
                
                // FORMATTING SHORTCUTS (integrated with our formatter component)
                "Ctrl-B": function(cm) { 
                    if (window.MarkdownFormatter) {
                        const formatter = new MarkdownFormatter(cm);
                        formatter.format('bold');
                    }
                },
                "Ctrl-I": function(cm) { 
                    if (window.MarkdownFormatter) {
                        const formatter = new MarkdownFormatter(cm);
                        formatter.format('italic');
                    }
                },
                
                // FILE OPERATIONS (integrated with IDE controller)
                "Ctrl-S": function(cm) {
                    // Save current file
                    if (window.ideController) {
                        window.ideController.saveFile();
                    }
                    return false; // Prevent browser's default save dialog
                }
            },
            
            // AUTOCOMPLETE CONFIGURATION
            hintOptions: {
                hint: CodeMirror.hint.anyword  // Suggest words from the document
            }
        });

        /**
         * COMPONENT INITIALIZATION
         * 
         * Initialize all the modular components that make up the editor system.
         */

        // Initialize live preview system (Obsidian-style behavior)
        const livePreview = new MarkdownLivePreview(editor, {
            enabled: true,                    // Start with preview enabled
            widgetClass: 'markdown-line-widget markdown'  // CSS classes for widgets
        });

        // Initialize formatting system
        const formatter = new MarkdownFormatter(editor);

        // Initialize search system
        const searcher = new EditorSearcher(editor, {
            caseSensitive: false,             // Case-insensitive search by default
            highlightClass: 'searching'       // CSS class for highlighting matches
        });

        /**
         * GLOBAL ACCESS
         * 
         * Make editor and components accessible globally for debugging
         * and external script integration.
         */
        window.cmEditor = editor;
        window.livePreview = livePreview;
        window.formatter = formatter;
        window.searcher = searcher;

        /**
         * TOOLBAR EVENT HANDLING
         * 
         * Set up event listeners for the formatting toolbar buttons.
         * Uses event delegation for efficient handling.
         */
        document.querySelector('.tool-bar-container').addEventListener('click', function(e) {
            const button = e.target.closest('.tool-bar-item');
            if (!button) return;

            const cmd = button.dataset.cmd;
            
            if (cmd) {
                // Handle standard formatting commands
                formatter.format(cmd);
            }
        });

        /**
         * SEARCH TOOLBAR EVENT HANDLING
         * 
         * Set up event listeners for the search and replace functionality.
         */

        // Real-time search as user types
        document.getElementById('find-input').addEventListener('input', function(e) {
            const query = e.target.value;
            if (query) {
                searcher.search(query);
            } else {
                searcher.clearHighlighting();
            }
        });

        // Search navigation buttons
        document.getElementById('find-next').addEventListener('click', function() {
            const query = document.getElementById('find-input').value;
            if (query) {
                searcher.search(query);
                searcher.findNext();
            }
        });

        document.getElementById('find-prev').addEventListener('click', function() {
            const query = document.getElementById('find-input').value;
            if (query) {
                searcher.search(query);
                searcher.findPrevious();
            }
        });

        // Replace functionality
        document.getElementById('replace-btn').addEventListener('click', function() {
            const query = document.getElementById('find-input').value;
            const replacement = document.getElementById('replace-input').value;
            if (query) {
                searcher.search(query);
                searcher.replaceNext(replacement);
            }
        });

        document.getElementById('replace-all-btn').addEventListener('click', function() {
            const query = document.getElementById('find-input').value;
            const replacement = document.getElementById('replace-input').value;
            if (query) {
                searcher.search(query);
                const count = searcher.replaceAll(replacement);
                alert(`Replaced ${count} occurrences`);
            }
        });

        // Close search toolbar
        document.getElementById('close-search').addEventListener('click', function() {
            // Clear search inputs and state
            document.getElementById('find-input').value = '';
            document.getElementById('replace-input').value = '';
            searcher.clearSearch();
        });

        // Keyboard handling in search inputs
        document.getElementById('find-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const query = e.target.value;
                if (query) {
                    searcher.search(query);
                    searcher.findNext();
                }
            }
        });

        document.getElementById('replace-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const query = document.getElementById('find-input').value;
                const replacement = e.target.value;
                if (query) {
                    searcher.search(query);
                    searcher.replaceNext(replacement);
                }
            }
        });

        /**
         * INITIALIZATION COMPLETE
         * 
         * The editor system is now fully initialized and ready for use.
         * All components are connected and working together.
         */
        
        // Optional: Trigger initial preview update
        livePreview.updatePreview();
    });
</script>