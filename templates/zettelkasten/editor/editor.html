{% load static %}
<div class="editor-bar">
    <ul class="editor-tabs">
        <li class="editor-tab" data-tab="editor">
            <div class="editor-tab-name">Zettel0 Lelor This is a long name</div>
            <div class="editor-tab-close" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                </svg>
            </div>
        </li>
        <li class="editor-tab active" data-tab="editor">
            <div class="editor-tab-name">Zettel1</div>
            <div class="editor-tab-close">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                </svg>
            </div>
        </li>
        <li class="editor-tab" data-tab="editor">
            <div class="editor-tab-name">Zettel2 Lelor This is a long name</div>
            <div class="editor-tab-close" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                </svg>
            </div>
        </li>
    </ul>
</div>

<!-- Custom Formatting Toolbar -->
<div id="formatting-toolbar" class="formatting-toolbar">
    <button type="button" data-cmd="bold" title="Bold (Ctrl+B)" style="border-left :  0.1px solid var(--border-light);">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
        <path fill-rule="evenodd" d="M5.246 3.744a.75.75 0 0 1 .75-.75h7.125a4.875 4.875 0 0 1 3.346 8.422 5.25 5.25 0 0 1-2.97 9.58h-7.5a.75.75 0 0 1-.75-.75V3.744Zm7.125 6.75a2.625 2.625 0 0 0 0-5.25H8.246v5.25h4.125Zm-4.125 2.251v6h4.5a3 3 0 0 0 0-6h-4.5Z" clip-rule="evenodd" />
        </svg>
    </button>
    <button type="button" data-cmd="italic" title="Italic (Ctrl+I)">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
            <path fill-rule="evenodd" d="M10.497 3.744a.75.75 0 0 1 .75-.75h7.5a.75.75 0 0 1 0 1.5h-3.275l-5.357 15.002h2.632a.75.75 0 1 1 0 1.5h-7.5a.75.75 0 1 1 0-1.5h3.275l5.357-15.002h-2.632a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" />
        </svg>
    </button>
    <button type="button" data-cmd="strikethrough" title="Strikethrough">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
  <path fill-rule="evenodd" d="M9.657 4.728c-1.086.385-1.766 1.057-1.979 1.85-.214.8.046 1.733.81 2.616.746.862 1.93 1.612 3.388 2.003.07.019.14.037.21.053h8.163a.75.75 0 0 1 0 1.5h-8.24a.66.66 0 0 1-.02 0H3.75a.75.75 0 0 1 0-1.5h4.78a7.108 7.108 0 0 1-1.175-1.074C6.372 9.042 5.849 7.61 6.229 6.19c.377-1.408 1.528-2.38 2.927-2.876 1.402-.497 3.127-.55 4.855-.086A8.937 8.937 0 0 1 16.94 4.6a.75.75 0 0 1-.881 1.215 7.437 7.437 0 0 0-2.436-1.14c-1.473-.394-2.885-.331-3.966.052Zm6.533 9.632a.75.75 0 0 1 1.03.25c.592.974.846 2.094.55 3.2-.378 1.408-1.529 2.38-2.927 2.876-1.402.497-3.127.55-4.855.087-1.712-.46-3.168-1.354-4.134-2.47a.75.75 0 0 1 1.134-.982c.746.862 1.93 1.612 3.388 2.003 1.473.394 2.884.331 3.966-.052 1.085-.384 1.766-1.056 1.978-1.85.169-.628.046-1.33-.381-2.032a.75.75 0 0 1 .25-1.03Z" clip-rule="evenodd" />
</svg>

    </button>
    <button type="button" data-cmd="code" title="Inline Code">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
  <path fill-rule="evenodd" d="M14.447 3.026a.75.75 0 0 1 .527.921l-4.5 16.5a.75.75 0 0 1-1.448-.394l4.5-16.5a.75.75 0 0 1 .921-.527ZM16.72 6.22a.75.75 0 0 1 1.06 0l5.25 5.25a.75.75 0 0 1 0 1.06l-5.25 5.25a.75.75 0 1 1-1.06-1.06L21.44 12l-4.72-4.72a.75.75 0 0 1 0-1.06Zm-9.44 0a.75.75 0 0 1 0 1.06L2.56 12l4.72 4.72a.75.75 0 0 1-1.06 1.06L.97 12.53a.75.75 0 0 1 0-1.06l5.25-5.25a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
</svg>

    </button>
    <button type="button" data-cmd="codeblock" title="Code Block">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
  <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 3v1.5M4.5 8.25H3m18 0h-1.5M4.5 12H3m18 0h-1.5m-15 3.75H3m18 0h-1.5M8.25 19.5V21M12 3v1.5m0 15V21m3.75-18v1.5m0 15V21m-9-1.5h10.5a2.25 2.25 0 0 0 2.25-2.25V6.75a2.25 2.25 0 0 0-2.25-2.25H6.75A2.25 2.25 0 0 0 4.5 6.75v10.5a2.25 2.25 0 0 0 2.25 2.25Zm.75-12h9v9h-9v-9Z" />
</svg>


    </button>
    <button type="button" data-cmd="link" title="Link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
  <path fill-rule="evenodd" d="M19.902 4.098a3.75 3.75 0 0 0-5.304 0l-4.5 4.5a3.75 3.75 0 0 0 1.035 6.037.75.75 0 0 1-.646 1.353 5.25 5.25 0 0 1-1.449-8.45l4.5-4.5a5.25 5.25 0 1 1 7.424 7.424l-1.757 1.757a.75.75 0 1 1-1.06-1.06l1.757-1.757a3.75 3.75 0 0 0 0-5.304Zm-7.389 4.267a.75.75 0 0 1 1-.353 5.25 5.25 0 0 1 1.449 8.45l-4.5 4.5a5.25 5.25 0 1 1-7.424-7.424l1.757-1.757a.75.75 0 1 1 1.06 1.06l-1.757 1.757a3.75 3.75 0 1 0 5.304 5.304l4.5-4.5a3.75 3.75 0 0 0-1.035-6.037.75.75 0 0 1-.354-1Z" clip-rule="evenodd" />
</svg>

    </button>
    <button type="button" data-cmd="header1" title="Header 1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
  <path fill-rule="evenodd" d="M2.243 3.743a.75.75 0 0 1 .75.75v6.75h9v-6.75a.75.75 0 1 1 1.5 0v15.002a.75.75 0 1 1-1.5 0v-6.751h-9v6.75a.75.75 0 1 1-1.5 0v-15a.75.75 0 0 1 .75-.75Zm17.605 4.964a.75.75 0 0 1 .396.661v9.376h1.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5h1.5V10.77l-1.084.722a.75.75 0 1 1-.832-1.248l2.25-1.5a.75.75 0 0 1 .77-.037Z" clip-rule="evenodd" />
</svg>

    </button>
    <button type="button" data-cmd="header2" title="Header 2">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
  <path fill-rule="evenodd" d="M2.246 3.743a.75.75 0 0 1 .75.75v6.75h9v-6.75a.75.75 0 0 1 1.5 0v15.002a.75.75 0 1 1-1.5 0v-6.751h-9v6.75a.75.75 0 1 1-1.5 0v-15a.75.75 0 0 1 .75-.75ZM18.75 10.5c-.727 0-1.441.054-2.138.16a.75.75 0 1 1-.223-1.484 15.867 15.867 0 0 1 3.635-.125c1.149.092 2.153.923 2.348 2.115.084.516.128 1.045.128 1.584 0 1.065-.676 1.927-1.531 2.354l-2.89 1.445a1.5 1.5 0 0 0-.829 1.342v.86h4.5a.75.75 0 1 1 0 1.5H16.5a.75.75 0 0 1-.75-.75v-1.61a3 3 0 0 1 1.659-2.684l2.89-1.445c.447-.223.701-.62.701-1.012a8.32 8.32 0 0 0-.108-1.342c-.075-.457-.47-.82-.987-.862a14.45 14.45 0 0 0-1.155-.046Z" clip-rule="evenodd" />
</svg>

    </button>
    <button type="button" data-cmd="header3" title="Header 3">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
  <path fill-rule="evenodd" d="M12.749 3.743a.75.75 0 0 1 .75.75v15.002a.75.75 0 1 1-1.5 0v-6.75H2.997v6.75a.75.75 0 0 1-1.5 0V4.494a.75.75 0 1 1 1.5 0v6.75H12v-6.75a.75.75 0 0 1 .75-.75ZM18.75 10.5c-.727 0-1.441.055-2.139.16a.75.75 0 1 1-.223-1.483 15.87 15.87 0 0 1 3.82-.11c.95.088 1.926.705 2.168 1.794a5.265 5.265 0 0 1-.579 3.765 5.265 5.265 0 0 1 .578 3.765c-.24 1.088-1.216 1.706-2.167 1.793a15.942 15.942 0 0 1-3.82-.109.75.75 0 0 1 .223-1.483 14.366 14.366 0 0 0 3.46.099c.467-.043.773-.322.84-.624a3.768 3.768 0 0 0-.413-2.691H18a.75.75 0 0 1 0-1.5h2.498a3.768 3.768 0 0 0 .413-2.69c-.067-.303-.373-.582-.84-.625-.435-.04-.876-.06-1.321-.06Z" clip-rule="evenodd" />
</svg>

    </button>
    <button type="button" data-cmd="list" title="List">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
        </svg>
    </button>
    <button type="button" data-cmd="quote" title="Quote">
       <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
  <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 0 1-.825-.242m9.345-8.334a2.126 2.126 0 0 0-.476-.095 48.64 48.64 0 0 0-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0 0 11.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.760 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155" />
</svg>

    </button>
    <button type="button" id="toggle-preview" title="Toggle Live Preview" style="border-left: 1px solid var(--border-light);">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
        </svg>
    </button>
</div>



<form method="post" style ="flex: 2; display: flex; flex-direction: column; height: 100%; width: 100%;">
    {% csrf_token %}
    <textarea id="code-editor" name="content">{{ content|default:'' }}</textarea>
</form>

<!-- Custom Find/Replace Toolbar -->
<div id="search-toolbar" class="search-toolbar" style="display: none;">
    <div class="search-controls">
        <div class = "search-inputs">
            <input type="text" id="find-input" placeholder="Find..."  style="border-left: 0.2px solid var(--border-light);"/>
            <input type="text" id="replace-input" placeholder="Replace..." />
        </div>

        <div class="search-buttons">
            <button type="button" id="find-prev" title="Previous">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5 12 3m0 0 7.5 7.5M12 3v18" />
                </svg>
            </button>
            <button type="button" id="find-next" title="Next">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5 12 21m0 0-7.5-7.5M12 21V3" />
                </svg>
            </button>
            <button type="button" id="replace-btn" title="Replace">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
    <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 8.25 21 12m0 0-3.75 3.75M21 12H3" />
    </svg>

            </button>
            <button type="button" id="replace-all-btn" title="Replace All">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
    <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21 3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
    </svg>

            </button>
            <button type="button" id="close-search" title="Close">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                    <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
    </div>
</div>

<!-- CodeMirror Core -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">

<!-- Theme -->
<link rel="stylesheet" href="{% static 'css/03-pages/_codemirror.css' %}">

<!-- Markdown Live Preview Styles -->
<link rel="stylesheet" href="{% static 'css/03-pages/_markdown-preview.css' %}">

<!-- Fold Gutter CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.css">

<!-- Autocomplete CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css">

<!-- CodeMirror JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>

<!-- Markdown Mode -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>

<!-- Extra Modes for Embedded Code -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>

<!-- Addons: Editing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>

<!-- Addons: Selection + Active Line -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/selection/active-line.min.js"></script>

<!-- Addons: Folding -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/markdown-fold.min.js"></script>

<!-- Addons: Search -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/searchcursor.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/search.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/dialog/dialog.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/dialog/dialog.min.css">

<!-- Addons: Autocomplete -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/anyword-hint.min.js"></script>

<!-- Keymap: Sublime -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/keymap/sublime.min.js"></script>

<!-- Addons: Replace -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/replace.min.js"></script>

<!-- Markdown Parser for Live Preview -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- Initialize CodeMirror -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Live Preview Implementation
        class MarkdownLivePreview {
            constructor(editor) {
                this.editor = editor;
                this.currentCursorLine = -1;
                this.renderedLines = new Map();
                this.enabled = true;
                
                // Configure marked for consistent rendering
                if (typeof marked !== 'undefined') {
                    marked.setOptions({
                        breaks: true,
                        gfm: true,
                        sanitize: false
                    });
                }

                this.setupEventListeners();
                this.updatePreview();
            }

            enable() {
                this.enabled = true;
                this.updatePreview();
            }

            disable() {
                this.enabled = false;
                this.clearAllRendering();
            }

            clearAllRendering() {
                const lineCount = this.editor.lineCount();
                for (let i = 0; i < lineCount; i++) {
                    const lineHandle = this.editor.getLineHandle(i);
                    if (lineHandle && lineHandle.widgets) {
                        lineHandle.widgets.forEach(widget => widget.clear());
                    }
                    this.editor.removeLineClass(i, 'wrap', 'markdown-rendered');
                    this.editor.removeLineClass(i, 'wrap', 'markdown-editing');
                    this.editor.removeLineClass(i, 'text', 'hidden-line');
                }
            }

            setupEventListeners() {
                // Update preview on cursor change
                this.editor.on('cursorActivity', () => {
                    this.updateCursorLine();
                });

                // Update preview on content change
                this.editor.on('change', () => {
                    this.updatePreview();
                });

                // Initial render
                this.editor.on('refresh', () => {
                    this.updatePreview();
                });
            }

            updateCursorLine() {
                if (!this.enabled) return;
                
                const newCursorLine = this.editor.getCursor().line;
                if (newCursorLine !== this.currentCursorLine) {
                    const oldLine = this.currentCursorLine;
                    this.currentCursorLine = newCursorLine;
                    
                    // Re-render the old cursor line as markdown
                    if (oldLine >= 0) {
                        this.renderLine(oldLine, false);
                    }
                    
                    // Show the new cursor line as raw markdown
                    this.renderLine(this.currentCursorLine, true);
                }
            }

            updatePreview() {
                if (!this.enabled) return;
                
                const lineCount = this.editor.lineCount();
                
                for (let i = 0; i < lineCount; i++) {
                    const isCurrentLine = i === this.currentCursorLine;
                    this.renderLine(i, isCurrentLine);
                }
            }

            renderLine(lineNumber, isEditing) {
                if (lineNumber < 0 || lineNumber >= this.editor.lineCount()) return;

                const lineHandle = this.editor.getLineHandle(lineNumber);
                if (!lineHandle) return;

                const lineText = this.editor.getLine(lineNumber);
                
                // Clear existing widgets on this line
                if (lineHandle.widgets) {
                    lineHandle.widgets.forEach(widget => widget.clear());
                }

                if (isEditing || !lineText.trim()) {
                    // Show raw markdown for current line or empty lines
                    this.editor.removeLineClass(lineNumber, 'wrap', 'markdown-rendered');
                    this.editor.removeLineClass(lineNumber, 'text', 'hidden-line');
                    this.editor.addLineClass(lineNumber, 'wrap', 'markdown-editing');
                    return;
                }

                // Render as markdown for non-current lines
                this.editor.removeLineClass(lineNumber, 'wrap', 'markdown-editing');
                this.editor.addLineClass(lineNumber, 'wrap', 'markdown-rendered');

                // Create rendered content
                const renderedContent = this.renderMarkdownLine(lineText);
                if (renderedContent && renderedContent !== lineText) {
                    this.createLineWidget(lineNumber, renderedContent);
                }
            }

            renderMarkdownLine(text) {
                if (!text.trim()) return '';

                try {
                    // Handle different markdown elements
                    let rendered = text;

                    // Headers
                    if (text.match(/^#{1,6}\s/)) {
                        const level = text.match(/^#+/)[0].length;
                        const content = text.replace(/^#+\s/, '');
                        rendered = `<h${level} class="markdown-header">${this.escapeHtml(content)}</h${level}>`;
                    }
                    // Bold and Italic combined
                    else if (text.includes('***')) {
                        rendered = text.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
                    }
                    // Bold
                    else if (text.includes('**') || text.includes('__')) {
                        rendered = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                      .replace(/__(.*?)__/g, '<strong>$1</strong>');
                    }
                    // Italic
                    else if (text.includes('*') || text.includes('_')) {
                        rendered = text.replace(/\*(.*?)\*/g, '<em>$1</em>')
                                      .replace(/_(.*?)_/g, '<em>$1</em>');
                    }
                    // Strikethrough
                    else if (text.includes('~~')) {
                        rendered = text.replace(/~~(.*?)~~/g, '<del>$1</del>');
                    }
                    // Inline code
                    else if (text.includes('`')) {
                        rendered = text.replace(/`([^`]+)`/g, '<code>$1</code>');
                    }
                    // Links
                    else if (text.includes('[') && text.includes('](')) {
                        rendered = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');
                    }
                    // Lists
                    else if (text.match(/^[\s]*[-*+]\s/)) {
                        const content = text.replace(/^[\s]*[-*+]\s/, '');
                        rendered = `<li>${this.escapeHtml(content)}</li>`;
                    }
                    // Numbered lists
                    else if (text.match(/^[\s]*\d+\.\s/)) {
                        const content = text.replace(/^[\s]*\d+\.\s/, '');
                        rendered = `<li>${this.escapeHtml(content)}</li>`;
                    }
                    // Blockquotes
                    else if (text.match(/^>\s/)) {
                        const content = text.replace(/^>\s/, '');
                        rendered = `<blockquote><p>${this.escapeHtml(content)}</p></blockquote>`;
                    }

                    return rendered;
                } catch (error) {
                    console.error('Error rendering markdown:', error);
                    return text;
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            createLineWidget(lineNumber, renderedContent) {
                const widget = document.createElement('div');
                widget.className = 'markdown-line-widget markdown';
                widget.innerHTML = renderedContent;
                
                // Style the widget
                widget.style.cssText = `
                    font-family: var(--font-family-body);
                    line-height: var(--line-height-relaxed);
                    color: var(--text-primary);
                    margin: 0;
                    padding: 2px 0;
                    background: transparent;
                `;

                // Hide the original line text
                this.editor.addLineClass(lineNumber, 'text', 'hidden-line');
                
                // Add the widget
                this.editor.addLineWidget(lineNumber, widget, {
                    coverGutter: false,
                    noHScroll: true,
                    above: false
                });
            }
        }

        // Initialize CodeMirror
        const editor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
            mode: "markdown",
            theme: "mytheme",
            lineNumbers: true,
            lineWrapping: true,
            styleActiveLine: true,
            matchBrackets: true,
            autoCloseBrackets: true,
            foldGutter: true,
            inputStyle: "contenteditable", 
            spellcheck: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
            keyMap: "sublime",
            extraKeys: {
                "Ctrl-Space": "autocomplete",
                "Ctrl-Q": function(cm) { cm.foldCode(cm.getCursor()); },
                "Ctrl-F": function(cm) { 
                    document.getElementById('search-toolbar').style.display = 'flex';
                    document.getElementById('find-input').focus();
                },
                "Ctrl-H": function(cm) { 
                    document.getElementById('search-toolbar').style.display = 'flex';
                    document.getElementById('replace-input').focus();
                },
                "Esc": function(cm) {
                    document.getElementById('search-toolbar').style.display = 'none';
                },
                "Ctrl-B": function(cm) { formatText(cm, 'bold'); },
                "Ctrl-I": function(cm) { formatText(cm, 'italic'); }
            },
            hintOptions: {
                hint: CodeMirror.hint.anyword
            }
        });

        // Initialize live preview
        const livePreview = new MarkdownLivePreview(editor);

        // Make editor globally accessible
        window.cmEditor = editor;
        window.livePreview = livePreview;

        // Formatting functions
        function formatText(cm, type) {
            const selection = cm.getSelection();
            const cursor = cm.getCursor();
            let replacement = '';

            switch(type) {
                case 'bold':
                    replacement = selection ? `**${selection}**` : '**bold text**';
                    break;
                case 'italic':
                    replacement = selection ? `*${selection}*` : '*italic text*';
                    break;
                case 'strikethrough':
                    replacement = selection ? `~~${selection}~~` : '~~strikethrough text~~';
                    break;
                case 'code':
                    replacement = selection ? `\`${selection}\`` : '`code`';
                    break;
                case 'codeblock':
                    replacement = selection ? `\`\`\`\n${selection}\n\`\`\`` : '```\ncode block\n```';
                    break;
                case 'link':
                    replacement = selection ? `[${selection}](url)` : '[link text](url)';
                    break;
                case 'header1':
                    replacement = selection ? `# ${selection}` : '# Header 1';
                    break;
                case 'header2':
                    replacement = selection ? `## ${selection}` : '## Header 2';
                    break;
                case 'header3':
                    replacement = selection ? `### ${selection}` : '### Header 3';
                    break;
                case 'list':
                    replacement = selection ? `- ${selection}` : '- List item';
                    break;
                case 'quote':
                    replacement = selection ? `> ${selection}` : '> Quote';
                    break;
            }

            cm.replaceSelection(replacement);
            cm.focus();
        }

        // Formatting toolbar event listener
        document.getElementById('formatting-toolbar').addEventListener('click', function(e) {
            if (e.target.closest('button')) {
                const button = e.target.closest('button');
                const cmd = button.dataset.cmd;
                
                if (cmd) {
                    formatText(editor, cmd);
                } else if (button.id === 'toggle-preview') {
                    // Handle preview toggle
                    livePreview.enabled = !livePreview.enabled;
                    
                    if (livePreview.enabled) {
                        livePreview.enable();
                        button.style.background = 'transparent';
                        button.title = 'Disable Live Preview';
                    } else {
                        livePreview.disable();
                        button.style.background = 'var(--color-primary-300)';
                        button.title = 'Enable Live Preview';
                    }
                }
            }
        });

        // Search functionality
        let searchState = {
            query: '',
            lastQuery: '',
            overlay: null
        };

        function doSearch(cm, query) {
            if (searchState.overlay) cm.removeOverlay(searchState.overlay);
            if (!query) return;

            searchState.overlay = {
                token: function(stream) {
                    if (stream.match(new RegExp(query, 'gi'))) {
                        return 'searching';
                    }
                    stream.next();
                    stream.skipToEnd();
                }
            };
            cm.addOverlay(searchState.overlay);
        }

        function findNext(cm, query) {
            const cursor = cm.getSearchCursor(query, cm.getCursor());
            if (cursor.findNext()) {
                cm.setSelection(cursor.from(), cursor.to());
                cm.scrollIntoView(cursor.from());
            } else {
                // Wrap around
                const cursor2 = cm.getSearchCursor(query);
                if (cursor2.findNext()) {
                    cm.setSelection(cursor2.from(), cursor2.to());
                    cm.scrollIntoView(cursor2.from());
                }
            }
        }

        function findPrev(cm, query) {
            const cursor = cm.getSearchCursor(query, cm.getCursor());
            if (cursor.findPrevious()) {
                cm.setSelection(cursor.from(), cursor.to());
                cm.scrollIntoView(cursor.from());
            } else {
                // Wrap around
                const cursor2 = cm.getSearchCursor(query, CodeMirror.Pos(cm.lastLine()));
                if (cursor2.findPrevious()) {
                    cm.setSelection(cursor2.from(), cursor2.to());
                    cm.scrollIntoView(cursor2.from());
                }
            }
        }

        function replaceNext(cm, query, replacement) {
            const cursor = cm.getSearchCursor(query, cm.getCursor());
            if (cursor.findNext()) {
                cursor.replace(replacement);
                cm.setSelection(cursor.from(), cursor.to());
            }
        }

        function replaceAll(cm, query, replacement) {
            const cursor = cm.getSearchCursor(query);
            let count = 0;
            while (cursor.findNext()) {
                cursor.replace(replacement);
                count++;
            }
            alert(`Replaced ${count} occurrences`);
        }

        // Search toolbar event listeners
        document.getElementById('find-input').addEventListener('input', function(e) {
            const query = e.target.value;
            searchState.query = query;
            doSearch(editor, query);
        });

        document.getElementById('find-next').addEventListener('click', function() {
            const query = document.getElementById('find-input').value;
            if (query) findNext(editor, query);
        });

        document.getElementById('find-prev').addEventListener('click', function() {
            const query = document.getElementById('find-input').value;
            if (query) findPrev(editor, query);
        });

        document.getElementById('replace-btn').addEventListener('click', function() {
            const query = document.getElementById('find-input').value;
            const replacement = document.getElementById('replace-input').value;
            if (query) replaceNext(editor, query, replacement);
        });

        document.getElementById('replace-all-btn').addEventListener('click', function() {
            const query = document.getElementById('find-input').value;
            const replacement = document.getElementById('replace-input').value;
            if (query) replaceAll(editor, query, replacement);
        });

        document.getElementById('close-search').addEventListener('click', function() {
            document.getElementById('search-toolbar').style.display = 'none';
            if (searchState.overlay) editor.removeOverlay(searchState.overlay);
            document.getElementById('find-input').value = '';
            document.getElementById('replace-input').value = '';
        });

        // Enter key handling in search inputs
        document.getElementById('find-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                findNext(editor, e.target.value);
            }
        });

        document.getElementById('replace-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const query = document.getElementById('find-input').value;
                if (query) replaceNext(editor, query, e.target.value);
            }
        });
    });
</script>
