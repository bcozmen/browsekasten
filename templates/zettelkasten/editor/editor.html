<!--
    MODULAR ZETTELKASTEN MARKDOWN EDITOR
    
    This is the main editor template that combines all modular components
    into a cohesive markdown editing experience with live preview.
    
    COMPONENT ARCHITECTURE:
    - Base HTML structure (tabs, form)
    - Toolbar component (formatting buttons)
    - Search component (find/replace)
    - CodeMirror editor (text editing)
    - Live preview system (Obsidian-style)
    - Shared CSS styling (works for both editor and blog)
    
    FEATURES:
    - Obsidian-style live preview (cursor line = raw, others = rendered)
    - Comprehensive formatting toolbar
    - Advanced search and replace
    - Keyboard shortcuts
    - Responsive design
    - Extensible component system
    
    USAGE:
    This template should be included in your main page and will automatically
    initialize all components when the DOM is loaded.
-->

{% load static %}

<!--
    EDITOR SYSTEM OVERVIEW COMMENT
    
    This editor implements an Obsidian-style live markdown preview system using CodeMirror 5.x.
    The key concept is that lines with the cursor show raw markdown (editable), while other 
    lines show rendered HTML output (read-only preview).
    
    ARCHITECTURE:
    1. CodeMirror Editor: Provides the core text editing functionality
    2. MarkdownLivePreview Class: Manages the live preview rendering
    3. Line Widgets: Overlay HTML content on top of markdown lines
    4. CSS Classes: Control visibility and styling of raw vs rendered content
    5. Event System: Responds to cursor movement and content changes
    6. Modular Components: Separate files for toolbar, search, formatting, etc.
-->

<!--
    EDITOR TABS BAR
    
    This section creates a tab-like interface for multiple documents.
    Currently visual only - functionality for opening/closing multiple files
    would need to be implemented separately.
-->
<div class="editor-bar">
    <ul class="editor-tabs">
        <!-- Tab 1: Inactive tab with hidden close button -->
        <li class="editor-tab" data-tab="editor">
            <div class="editor-tab-name">Zettel0 Lelor This is a long name</div>
            <div class="editor-tab-close" style="display: none;">
                <!-- Close icon (X) -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                </svg>
            </div>
        </li>
        
        <!-- Tab 2: Active tab with visible close button -->
        <li class="editor-tab active" data-tab="editor">
            <div class="editor-tab-name">Zettel1</div>
            <div class="editor-tab-close">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                </svg>
            </div>
        </li>
        
        <!-- Tab 3: Another inactive tab -->
        <li class="editor-tab" data-tab="editor">
            <div class="editor-tab-name">Zettel2 Lelor This is a long name</div>
            <div class="editor-tab-close" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                </svg>
            </div>
        </li>
    </ul>
</div>

<!-- FORMATTING TOOLBAR COMPONENT -->
{% include 'zettelkasten/editor/toolbar.html' %}

<!--
    MAIN EDITOR FORM
    
    Contains the textarea that CodeMirror will replace with the rich editor.
    The form handles saving the markdown content back to the server.
-->
<form method="post" style="flex: 2; display: flex; flex-direction: column; height: 100%; width: 100%;">
    {% csrf_token %}
    <!--
        TEXTAREA FOR CODEMIRROR
        
        This textarea will be replaced by CodeMirror with a rich editing interface.
        The name="content" ensures the form submission works correctly.
    -->
    <textarea id="code-editor" name="content">{{ content|default:'' }}</textarea>
</form>

<!-- SEARCH AND REPLACE TOOLBAR COMPONENT -->
{% include 'zettelkasten/editor/search-toolbar.html' %}

<!--
    CSS INCLUDES
    
    Load all necessary stylesheets for the editor system.
    Order is important for proper style cascading.
-->

<!-- CodeMirror Core CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">

<!-- Custom CodeMirror Theme -->
<link rel="stylesheet" href="{% static 'css/03-pages/_codemirror.css' %}">

<!-- Shared Markdown Styling (works for both editor and blog) -->
<link rel="stylesheet" href="{% static 'css/03-pages/_markdown-shared.css' %}">

<!-- CodeMirror Addon CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/dialog/dialog.min.css">

<!--
    JAVASCRIPT INCLUDES
    
    Load all necessary JavaScript libraries and components.
    Order matters for dependencies.
-->

<!-- CodeMirror Core -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>

<!-- CodeMirror Language Modes -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>

<!-- CodeMirror Addons -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/selection/active-line.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/markdown-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/searchcursor.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/search.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/dialog/dialog.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/anyword-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/keymap/sublime.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/replace.min.js"></script>

<!-- Markdown Parser -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- Custom Components -->
<script src="{% static 'js/03-components/markdown-live-preview.js' %}"></script>
<script src="{% static 'js/03-components/markdown-formatter.js' %}"></script>
<script src="{% static 'js/03-components/editor-search.js' %}"></script>

<!--
    EDITOR INITIALIZATION SCRIPT
    
    This script ties together all the components and initializes the complete editor system.
    It's kept minimal by delegating functionality to the modular components.
-->
<script>
    /**
     * EDITOR INITIALIZATION
     * 
     * Initialize the complete markdown editor system when the DOM is ready.
     * This script coordinates all the modular components into a cohesive editor.
     */
    document.addEventListener("DOMContentLoaded", function () {
        
        /**
         * CODEMIRROR EDITOR INITIALIZATION
         * 
         * Create the main CodeMirror editor instance with optimal configuration
         * for markdown editing with live preview.
         */
        const editor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
            // BASIC CONFIGURATION
            mode: "markdown",           // Enable markdown syntax highlighting
            theme: "mytheme",          // Use custom CSS theme (defined in _codemirror.css)
            lineNumbers: true,         // Show line numbers in gutter
            lineWrapping: true,        // Wrap long lines instead of horizontal scroll
            styleActiveLine: true,     // Highlight the current line
            
            // BRACKET MATCHING AND AUTO-COMPLETION
            matchBrackets: true,       // Highlight matching brackets
            autoCloseBrackets: true,   // Automatically close brackets/quotes
            
            // CODE FOLDING SUPPORT
            foldGutter: true,          // Enable code folding in gutter
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
            
            // INPUT AND ACCESSIBILITY
            inputStyle: "contenteditable",  // Better mobile support and accessibility
            spellcheck: true,              // Enable browser spellcheck
            
            // KEYBOARD SHORTCUTS AND BEHAVIOR
            keyMap: "sublime",         // Use Sublime Text-style keyboard shortcuts
            
            /**
             * CUSTOM KEYBOARD SHORTCUTS
             * 
             * Define additional keyboard shortcuts that integrate with our components.
             */
            extraKeys: {
                // COMPLETION AND FOLDING
                "Ctrl-Space": "autocomplete",                    // Trigger word completion
                "Ctrl-Q": function(cm) { cm.foldCode(cm.getCursor()); }, // Toggle code folding
                
                // SEARCH AND REPLACE (integrated with our search component)
                "Ctrl-F": function(cm) { 
                    document.getElementById('search-toolbar').style.display = 'flex';
                    document.getElementById('find-input').focus();
                },
                "Ctrl-H": function(cm) { 
                    document.getElementById('search-toolbar').style.display = 'flex';
                    document.getElementById('replace-input').focus();
                },
                "Esc": function(cm) {
                    document.getElementById('search-toolbar').style.display = 'none';
                },
                
                // FORMATTING SHORTCUTS (integrated with our formatter component)
                "Ctrl-B": function(cm) { 
                    if (window.MarkdownFormatter) {
                        const formatter = new MarkdownFormatter(cm);
                        formatter.format('bold');
                    }
                },
                "Ctrl-I": function(cm) { 
                    if (window.MarkdownFormatter) {
                        const formatter = new MarkdownFormatter(cm);
                        formatter.format('italic');
                    }
                }
            },
            
            // AUTOCOMPLETE CONFIGURATION
            hintOptions: {
                hint: CodeMirror.hint.anyword  // Suggest words from the document
            }
        });

        /**
         * COMPONENT INITIALIZATION
         * 
         * Initialize all the modular components that make up the editor system.
         */

        // Initialize live preview system (Obsidian-style behavior)
        const livePreview = new MarkdownLivePreview(editor, {
            enabled: true,                    // Start with preview enabled
            widgetClass: 'markdown-line-widget markdown'  // CSS classes for widgets
        });

        // Initialize formatting system
        const formatter = new MarkdownFormatter(editor);

        // Initialize search system
        const searcher = new EditorSearcher(editor, {
            caseSensitive: false,             // Case-insensitive search by default
            highlightClass: 'searching'       // CSS class for highlighting matches
        });

        /**
         * GLOBAL ACCESS
         * 
         * Make editor and components accessible globally for debugging
         * and external script integration.
         */
        window.cmEditor = editor;
        window.livePreview = livePreview;
        window.formatter = formatter;
        window.searcher = searcher;

        /**
         * TOOLBAR EVENT HANDLING
         * 
         * Set up event listeners for the formatting toolbar buttons.
         * Uses event delegation for efficient handling.
         */
        document.getElementById('formatting-toolbar').addEventListener('click', function(e) {
            const button = e.target.closest('button');
            if (!button) return;

            const cmd = button.dataset.cmd;
            
            if (cmd) {
                // Handle standard formatting commands
                formatter.format(cmd);
            } else if (button.id === 'toggle-preview') {
                // Handle live preview toggle
                const isEnabled = livePreview.toggle();
                
                // Update button appearance based on state
                if (isEnabled) {
                    button.style.background = 'transparent';
                    button.title = 'Disable Live Preview';
                } else {
                    button.style.background = 'var(--color-primary-300)';
                    button.title = 'Enable Live Preview';
                }
            }
        });

        /**
         * SEARCH TOOLBAR EVENT HANDLING
         * 
         * Set up event listeners for the search and replace functionality.
         */

        // Real-time search as user types
        document.getElementById('find-input').addEventListener('input', function(e) {
            const query = e.target.value;
            if (query) {
                searcher.search(query);
            } else {
                searcher.clearHighlighting();
            }
        });

        // Search navigation buttons
        document.getElementById('find-next').addEventListener('click', function() {
            const query = document.getElementById('find-input').value;
            if (query) {
                searcher.search(query);
                searcher.findNext();
            }
        });

        document.getElementById('find-prev').addEventListener('click', function() {
            const query = document.getElementById('find-input').value;
            if (query) {
                searcher.search(query);
                searcher.findPrevious();
            }
        });

        // Replace functionality
        document.getElementById('replace-btn').addEventListener('click', function() {
            const query = document.getElementById('find-input').value;
            const replacement = document.getElementById('replace-input').value;
            if (query) {
                searcher.search(query);
                searcher.replaceNext(replacement);
            }
        });

        document.getElementById('replace-all-btn').addEventListener('click', function() {
            const query = document.getElementById('find-input').value;
            const replacement = document.getElementById('replace-input').value;
            if (query) {
                searcher.search(query);
                const count = searcher.replaceAll(replacement);
                alert(`Replaced ${count} occurrences`);
            }
        });

        // Close search toolbar
        document.getElementById('close-search').addEventListener('click', function() {
            document.getElementById('search-toolbar').style.display = 'none';
            searcher.clearSearch();
            document.getElementById('find-input').value = '';
            document.getElementById('replace-input').value = '';
        });

        // Keyboard handling in search inputs
        document.getElementById('find-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const query = e.target.value;
                if (query) {
                    searcher.search(query);
                    searcher.findNext();
                }
            }
        });

        document.getElementById('replace-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const query = document.getElementById('find-input').value;
                const replacement = e.target.value;
                if (query) {
                    searcher.search(query);
                    searcher.replaceNext(replacement);
                }
            }
        });

        /**
         * INITIALIZATION COMPLETE
         * 
         * The editor system is now fully initialized and ready for use.
         * All components are connected and working together.
         */
        console.log('Markdown editor system initialized successfully');
        
        // Optional: Trigger initial preview update
        livePreview.updatePreview();
    });
</script>

<!--
    EDITOR SYSTEM NOTES:
    
    MODULAR ARCHITECTURE:
    - Each major feature is in its own component file
    - Components can be used independently in other projects
    - Easy to maintain, test, and extend
    
    REUSABLE STYLING:
    - _markdown-shared.css works for both editor preview and blog display
    - Consistent appearance across all markdown content
    - Easy to theme and customize
    
    EXTENSIBILITY:
    - Add new formatting options by extending the formatter
    - Add new search features by extending the searcher
    - Add new preview modes by extending the live preview
    
    PERFORMANCE:
    - Components are lazy-loaded and only initialized when needed
    - Search highlighting uses efficient overlay system
    - Live preview only updates changed lines
    
    ACCESSIBILITY:
    - Keyboard shortcuts for all major functions
    - Screen reader compatible
    - High contrast support
    - Focus management
-->
